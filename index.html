<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Qalqonsimon AI — UTT yordamchi demo</title>

  <style>
    :root{
      --bg:#eef4fb; --card:#ffffff; --ink:#0b1220; --muted:#526176;
      --blue:#0b5ea8; --blue2:#0a4f95; --teal:#0c7c6a;
      --border:#d8e6ff; --soft:#f6faff;
      --shadow: 0 14px 36px rgba(10, 30, 70, .10);
      --radius: 22px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      background: radial-gradient(1200px 700px at 50% -10%, #ffffff 0%, var(--bg) 50%, #eaf2ff 100%);
      color:var(--ink);
    }
    .wrap{ max-width: 1440px; margin: 18px auto 26px; padding: 0 18px; }
    .header{
      background: linear-gradient(180deg, #ffffff, #fbfdff);
      border:1px solid var(--border);
      border-radius: 28px;
      box-shadow: var(--shadow);
      padding: 18px 22px 14px;
    }

    .hdr-top{
      display:grid;
      grid-template-columns: 360px 1fr 360px;
      align-items:center;
      gap:14px;
    }
    .logoCol{ display:flex; flex-direction:column; align-items:flex-start; gap:8px; }
    .logoCol.right{ align-items:flex-end; text-align:right; }
    .logo{ width:58px; height:58px; border-radius:14px; object-fit:contain; background:#fff;
      border:1px solid #e3edff; padding:6px; box-shadow: 0 10px 22px rgba(11,94,168,.10); }
    .logoText{
      font-size:18px; font-weight:1000; color:#13233a;
      line-height:1.1; white-space:nowrap;
    }

    .centerTitle{ text-align:center; }
    .title{ margin:0; font-weight:1000; letter-spacing:7px; font-size:46px; line-height:1.05; }
    .subtitle{ margin:6px 0 0; font-weight:800; color:#1f3b63; }
    .desc{ margin:10px auto 0; max-width:820px; color:var(--muted); font-size:14px; line-height:1.45; }

    .controls{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 280px 1fr 1fr 160px 130px;
      gap:10px;
      align-items:center;
    }
    .btn{
      border:0; border-radius:14px; padding:11px 14px;
      font-weight:1000; cursor:pointer; transition:.15s transform ease, .15s opacity ease;
      box-shadow: 0 12px 26px rgba(0,0,0,.08);
    }
    .btn:active{ transform: scale(.985); }
    .btn.blue{ background: linear-gradient(180deg, #1673c9, var(--blue)); color:#fff; }
    .btn.green{ background: linear-gradient(180deg, #1aa34f, #128842); color:#fff; }
    .btn.gray{ background: linear-gradient(180deg, #465365, #313b49); color:#fff; }
    .btn:disabled{ opacity:.65; cursor:not-allowed; }

    .fileRow{ display:flex; gap:10px; align-items:center; min-width:0; }
    input[type="file"]{ display:none; }
    .fileName{
      flex:1; min-width:0; font-size:13px; color:#2b3c54;
      border:1px solid var(--border); border-radius:14px; padding:11px 12px;
      background: var(--soft); overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .inp{
      width:100%; border:1px solid var(--border); border-radius:14px;
      padding:11px 12px; background:#fff; outline:none; font-size:14px;
    }
    .inp:focus{ border-color:#9cc1ea; box-shadow: 0 0 0 4px rgba(11,94,168,.12); }

    .grid{ display:grid; grid-template-columns: 1.15fr .85fr; gap:14px; margin-top:14px; }
    .card{
      background: var(--card); border: 1px solid var(--border);
      border-radius: var(--radius); box-shadow: var(--shadow); overflow:hidden;
    }
    .cardHead{
      background: linear-gradient(90deg, var(--blue2), var(--blue));
      color:#fff; padding: 11px 14px; font-weight: 1000; font-size: 18px;
    }
    .cardBody{ padding:14px; }

    .imgFrame{
      background:#f1f7ff; border:1px solid #dfeaff; border-radius:18px;
      min-height:520px; position:relative; overflow:hidden;
      display:flex; align-items:center; justify-content:center;
    }
    .imgFrame img{ width:100%; height:100%; object-fit:cover; display:block; }
    .placeholder{ color:#6a7a8f; text-align:center; font-weight:1000; }
    .help{ margin-top:10px; color:#415166; font-size:13px; line-height:1.35; }

    .center{ text-align:center; }
    .pill{
      display:inline-block; padding:9px 16px; border-radius:999px;
      background: linear-gradient(180deg, #0e6cc3, #0a5196);
      color:#fff; font-weight:1000; font-size:13px; margin:8px 0 12px;
      box-shadow: 0 10px 22px rgba(11,94,168,.14);
    }
    .bigBox{
      border:1px solid #dbe7ff; background: linear-gradient(180deg, #ffffff, #f5faff);
      border-radius:16px; padding:18px; min-height:86px;
      display:flex; align-items:center; justify-content:center;
      font-size:18px; font-weight:1000; text-align:center;
    }
    .midPill{
      display:inline-block; padding:10px 18px; border-radius:999px;
      background: linear-gradient(180deg, #0f9b7a, var(--teal));
      color:#fff; font-weight:1000; font-size:13px; margin:14px 0 10px;
      box-shadow: 0 10px 22px rgba(12,124,106,.16);
    }
    .roiPreview{
      margin-top:12px; width:100%; height:300px;
      border-radius:16px; border:1px solid #dfeaff; background:#fff;
      overflow:hidden; display:flex; align-items:center; justify-content:center;
    }
    .roiPreview img{ width:100%; height:100%; object-fit:cover; display:block; }

    .note{ margin-top:12px; color:#415166; font-size:13px; line-height:1.35; }
    .footer{ text-align:center; color:#6b7785; font-size:12px; margin-top:10px; }

    .modalBack{
      position:fixed; inset:0; background: rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center; padding:16px; z-index:50;
    }
    .modal{
      width:min(980px, 100%); background:#fff; border-radius:18px;
      box-shadow:0 20px 60px rgba(0,0,0,.25); overflow:hidden; border:1px solid rgba(0,0,0,.08);
    }
    .modalHead{
      display:flex; justify-content:space-between; align-items:center;
      padding:12px 14px; background:#0f2741; color:#fff; font-weight:1000;
    }
    .closeX{ cursor:pointer; font-size:18px; padding:4px 10px; border-radius:10px; background: rgba(255,255,255,.12); }
    .modalBody{ padding:12px; background:#0f2741; }
    .cropWrap{ background:#0b1320; border-radius:14px; overflow:hidden; border:1px solid rgba(255,255,255,.12); }
    canvas{ width:100%; height:auto; display:block; background:#000; cursor:crosshair; touch-action:none; }
    .hintBar{ margin-top:10px; color:#cfe6ff; font-size:13px; font-weight:900; text-align:center; }

    .modalBtns{ display:flex; gap:10px; justify-content:flex-end; padding:12px; background:#0f2741; }
    .btn.orange{ background: linear-gradient(180deg, #ffbd2e, #f0a81a); color:#1b1200; box-shadow:none; }
    .btn.white{ background:#eef3f8; color:#142033; box-shadow:none; }

    @media (max-width:1050px){
      .hdr-top{ grid-template-columns: 1fr; text-align:center; }
      .logoCol, .logoCol.right{ align-items:center; }
      .controls{ grid-template-columns: 1fr; }
      .grid{ grid-template-columns: 1fr; }
      .imgFrame{ min-height:360px; }
      .roiPreview{ height:240px; }
      .title{ font-size:40px; letter-spacing:5px; }
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="header">
      <div class="hdr-top">
        <div class="logoCol">
          <img class="logo" src="logo_left.png" alt="Logo chap" onerror="this.style.display='none'"/>
          <div class="logoText">Tibbiy radiologiya kafedrasi №2</div>
        </div>

        <div class="centerTitle">
          <h1 class="title">QALQONSIMON AI</h1>
          <div class="subtitle">UTT tasvirida tugunlarni aniqlash yordamchisi</div>
          <div class="desc">
            Rasmni yuklang va <b>“Tahlil qilish”</b> tugmasini bosing. (ROI + classifier ishlaydi.)
          </div>
        </div>

        <div class="logoCol right">
          <img class="logo" src="logo_right.png" alt="Logo o‘ng" onerror="this.style.display='none'"/>
          <div class="logoText">Toshkent Davlat Tibbiyot Universiteti</div>
        </div>
      </div>

      <div class="controls">
        <div class="fileRow">
          <label class="btn blue" for="file">Faylni tanlash</label>
          <input id="file" type="file" accept="image/*" />
          <div class="fileName" id="fileName">Fayl tanlanmadi</div>
        </div>

        <input class="inp" id="deviceName" placeholder="Apparat nomi (ixtiyoriy)" />
        <input class="inp" id="noduleSize" placeholder="Tugun o‘lchami (mm)" />

        <button class="btn green" id="analyzeBtn">Tahlil qilish</button>
        <button class="btn gray" id="resetBtn">Qayta tiklash</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="cardHead">Rasm</div>
        <div class="cardBody">
          <div class="imgFrame">
            <div class="placeholder" id="mainPlaceholder">Rasm yuklanmagan</div>
            <img id="mainImg" style="display:none;" alt="UTT rasm" />
          </div>
          <div class="help">
            “Tahlil qilish” → <b>AI bilan belgilash</b> / <b>Qo‘lda belgilash</b> / <b>Belgilanmasin</b>.
            Tanlangandan keyin ROI crop ko‘rsatiladi va tugun ehtimoli chiqadi.
          </div>
        </div>
      </div>

      <div class="card">
        <div class="cardHead">Natija</div>
        <div class="cardBody">
          <div class="center"><div class="pill">TUGUN MALIGNLIK EHTIMOLI</div></div>
          <div class="bigBox" id="riskBox">Rasm yuklang va tahlil qiling</div>

          <div class="center"><div class="midPill">MODEL XULOSASI</div></div>
          <div class="bigBox" id="summaryBox">—</div>

          <div class="roiPreview">
            <img id="roiImg" alt="ROI" style="display:none;" />
            <div id="roiPlaceholder" class="placeholder">ROI hali yo‘q</div>
          </div>

          <div class="note">
            Eslatma: Bu AI klinik qarorni almashtirmaydi. Yakuniy xulosa shifokor tomonidan klinik holat va qo‘shimcha tekshiruvlar asosida beriladi.
          </div>
        </div>
      </div>
    </div>

    <div class="footer">© Qalqonsimon AI Demo — Netlify frontend + HF backend (YOLO ROI + EfficientNet)</div>
  </div>

  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="modalHead">
        <div>ROI belgilash</div>
        <div class="closeX" id="closeModal">✕</div>
      </div>
      <div class="modalBody">
        <div class="cropWrap"><canvas id="canvas"></canvas></div>
        <div class="hintBar" id="hintBar">Variant tanlang.</div>
      </div>
      <div class="modalBtns">
        <button class="btn orange" id="aiBtn">AI bilan belgilash</button>
        <button class="btn white" id="manualBtn">Qo‘lda belgilash</button>
        <button class="btn gray" id="skipBtn">Belgilanmasin</button>
      </div>
    </div>
  </div>

<script>
  const API_BASE = "https://bekjonsattorov256-qalqonsimon-api.hf.space".replace(/\/+$/,"");

  const fileEl = document.getElementById("file");
  const fileNameEl = document.getElementById("fileName");
  const mainImg = document.getElementById("mainImg");
  const mainPlaceholder = document.getElementById("mainPlaceholder");

  const analyzeBtn = document.getElementById("analyzeBtn");
  const resetBtn = document.getElementById("resetBtn");

  const modalBack = document.getElementById("modalBack");
  const closeModal = document.getElementById("closeModal");
  const hintBar = document.getElementById("hintBar");

  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");

  const aiBtn = document.getElementById("aiBtn");
  const manualBtn = document.getElementById("manualBtn");
  const skipBtn = document.getElementById("skipBtn");

  const riskBox = document.getElementById("riskBox");
  const summaryBox = document.getElementById("summaryBox");

  const roiImg = document.getElementById("roiImg");
  const roiPlaceholder = document.getElementById("roiPlaceholder");

  let originalFile = null;
  let originalImage = new Image();
  let imgLoaded = false;

  let isSelecting = false;
  let start = null;
  let rect = null;

  function openModal(){
    modalBack.style.display = "flex";
    hintBar.textContent = "Variant tanlang.";
    setTimeout(drawCanvas, 60);
  }
  function closeModalFn(){
    modalBack.style.display = "none";
    isSelecting = false;
    start = null;
    rect = null;
    if (imgLoaded) drawCanvas();
  }

  function setMainFromBlob(blob){
    const url = URL.createObjectURL(blob);
    mainImg.onload = () => { mainImg.style.display="block"; mainPlaceholder.style.display="none"; };
    mainImg.src = url;
  }
  function setRoiPreview(blob){
    const url = URL.createObjectURL(blob);
    roiImg.onload = () => { roiImg.style.display="block"; roiPlaceholder.style.display="none"; };
    roiImg.src = url;
  }

  function resetOutputs(){
    riskBox.textContent = "Rasm yuklang va tahlil qiling";
    summaryBox.textContent = "—";
    roiImg.style.display="none";
    roiPlaceholder.style.display="block";
    roiImg.src="";
  }

  function fileToImage(file){
    return new Promise((resolve,reject)=>{
      const reader = new FileReader();
      reader.onload = () => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = reader.result;
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  function drawCanvas(){
    if(!imgLoaded) return;
    const wrapW = canvas.parentElement.clientWidth;
    const scale = wrapW / originalImage.width;

    canvas.width = Math.floor(originalImage.width * scale);
    canvas.height = Math.floor(originalImage.height * scale);

    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(originalImage, 0,0, canvas.width, canvas.height);

    if(rect){
      ctx.save();
      ctx.strokeStyle = "#2aa8ff";
      ctx.lineWidth = 3;
      ctx.strokeRect(rect.x, rect.y, rect.w, rect.h);
      ctx.fillStyle = "rgba(42,168,255,.12)";
      ctx.fillRect(rect.x, rect.y, rect.w, rect.h);
      ctx.restore();
    }
  }

  function cropFromRectScaledToOriginal(){
    const scale = originalImage.width / canvas.width;
    const x = Math.max(0, Math.round(rect.x * scale));
    const y = Math.max(0, Math.round(rect.y * scale));
    const w = Math.max(1, Math.round(rect.w * scale));
    const h = Math.max(1, Math.round(rect.h * scale));

    const tmp = document.createElement("canvas");
    tmp.width = w; tmp.height = h;
    const tctx = tmp.getContext("2d");
    tctx.drawImage(originalImage, x, y, w, h, 0, 0, w, h);
    return new Promise(resolve => tmp.toBlob(resolve, "image/jpeg", 0.95));
  }

  function cropByXYXY(x1,y1,x2,y2){
    const w = Math.max(1, Math.round(x2 - x1));
    const h = Math.max(1, Math.round(y2 - y1));
    const tmp = document.createElement("canvas");
    tmp.width = w; tmp.height = h;
    const tctx = tmp.getContext("2d");
    tctx.drawImage(originalImage, x1, y1, w, h, 0, 0, w, h);
    return new Promise(resolve => tmp.toBlob(resolve, "image/jpeg", 0.95));
  }

  async function postJson(url, fd){
    const res = await fetch(url, { method:"POST", body: fd, cache:"no-store" });
    const text = await res.text();
    let json=null; try{ json=JSON.parse(text);}catch(e){}
    return { ok: res.ok, status: res.status, text, json };
  }

  function triageUz(tr){
    if(tr==="benign") return "Yaxshi xulqli (benign)";
    if(tr==="suspicious") return "Shubhali (suspicious)";
    if(tr==="malignant") return "Yomon xulqli (malignant)";
    if(tr==="malignant_high") return "Yuqori xavf (malignant_high)";
    return tr || "—";
  }

  function showCls(p, triage){
    const pct = Math.round(Number(p) * 100);
    if(Number.isFinite(pct)){
      riskBox.textContent = `${pct}%`;
    } else {
      riskBox.textContent = "Natija topilmadi";
    }
    summaryBox.textContent = triageUz(triage);
  }

  // ========== Events ==========
  fileEl.addEventListener("change", async (e)=>{
    const f = e.target.files?.[0];
    if(!f) return;
    originalFile = f;
    fileNameEl.textContent = f.name;

    originalImage = await fileToImage(f);
    imgLoaded = true;

    mainImg.src = originalImage.src;
    mainImg.style.display = "block";
    mainPlaceholder.style.display = "none";

    resetOutputs();
  });

  analyzeBtn.addEventListener("click", ()=>{
    if(!originalFile){ alert("Avval rasm yuklang."); return; }
    openModal();
  });

  resetBtn.addEventListener("click", ()=>{
    originalFile = null; imgLoaded = false;
    fileEl.value = "";
    fileNameEl.textContent = "Fayl tanlanmadi";
    mainImg.style.display="none";
    mainPlaceholder.style.display="block";
    mainImg.src="";
    resetOutputs();
    closeModalFn();
  });

  closeModal.addEventListener("click", closeModalFn);
  modalBack.addEventListener("click", (e)=>{ if(e.target === modalBack) closeModalFn(); });

  // Manual ROI (crop -> /classify)
  canvas.addEventListener("mousedown", (e)=>{
    if(!isSelecting) return;
    const r = canvas.getBoundingClientRect();
    start = { x: e.clientX - r.left, y: e.clientY - r.top };
    rect = { x:start.x, y:start.y, w:1, h:1 };
    drawCanvas();
  });
  canvas.addEventListener("mousemove", (e)=>{
    if(!isSelecting || !start) return;
    const r = canvas.getBoundingClientRect();
    const x = e.clientX - r.left;
    const y = e.clientY - r.top;
    let w = x - start.x;
    let h = y - start.y;
    rect.x = w < 0 ? x : start.x;
    rect.y = h < 0 ? y : start.y;
    rect.w = Math.abs(w);
    rect.h = Math.abs(h);
    drawCanvas();
  });
  canvas.addEventListener("mouseup", async ()=>{
    if(!isSelecting || !rect) return;
    if(rect.w < 12 || rect.h < 12){
      hintBar.textContent = "ROI juda kichik. Qayta belgilang (drag).";
      rect = null; drawCanvas(); return;
    }
    isSelecting = false;

    const roiBlob = await cropFromRectScaledToOriginal();
    setRoiPreview(roiBlob);
    setMainFromBlob(roiBlob);

    // classifier
    const fd = new FormData();
    fd.append("image", roiBlob, "roi.jpg"); // backend /classify image deb kutadi :contentReference[oaicite:4]{index=4}
    const r = await postJson(`${API_BASE}/classify?t=${Date.now()}`, fd);

    if(!(r.ok && r.json && r.json.ok)){
      alert("Classifier xatolik:\n" + `Status: ${r.status}\n` + (r.text||"").slice(0,300));
      return;
    }
    showCls(r.json.p_malignant, r.json.triage);
    closeModalFn();
  });

  aiBtn.addEventListener("click", async ()=>{
    if(!originalFile) return;
    aiBtn.disabled = true;
    const old = aiBtn.textContent;
    aiBtn.textContent = "Kutib turing...";
    hintBar.textContent = "AI tahlil qilyapti...";

    try{
      const fd = new FormData();
      fd.append("image", originalFile); // backend /analyze image deb kutadi :contentReference[oaicite:5]{index=5}
      const r = await postJson(`${API_BASE}/analyze?t=${Date.now()}`, fd);

      if(!(r.ok && r.json && r.json.ok)){
        alert("AI analyze xatolik:\n" + `Status: ${r.status}\n` + (r.text||"").slice(0,300));
        return;
      }
      if(!r.json.found){
        alert(r.json.message || "Tugun topilmadi");
        return;
      }

      // bbox + crop display
      const xyxy = r.json.bbox;
      const [x1,y1,x2,y2] = xyxy.map(Number);
      const roiBlob = await cropByXYXY(x1,y1,x2,y2);
      setRoiPreview(roiBlob);
      setMainFromBlob(roiBlob);

      // show classifier output
      showCls(r.json.p_malignant, r.json.triage);

      closeModalFn();
    } finally {
      aiBtn.disabled = false;
      aiBtn.textContent = old;
    }
  });

  manualBtn.addEventListener("click", ()=>{
    if(!imgLoaded) return;
    isSelecting = true;
    rect = null; start = null;
    drawCanvas();
    hintBar.textContent = "ROI ni sichqoncha bilan tortib belgilang (drag) va qo‘yib yuboring.";
  });

  skipBtn.addEventListener("click", async ()=>{
    // rasm o‘zgarmasin, lekin istasangiz natija chiqsin:
    if(!originalFile){ closeModalFn(); return; }
    hintBar.textContent = "Tahlil qilinyapti...";
    const fd = new FormData();
    fd.append("image", originalFile);
    const r = await postJson(`${API_BASE}/analyze?t=${Date.now()}`, fd);
    if(r.ok && r.json && r.json.ok && r.json.found){
      showCls(r.json.p_malignant, r.json.triage);
      // ROI preview (ixtiyoriy)
      const [x1,y1,x2,y2] = r.json.bbox.map(Number);
      const roiBlob = await cropByXYXY(x1,y1,x2,y2);
      setRoiPreview(roiBlob);
    } else if(r.ok && r.json && r.json.ok && !r.json.found){
      alert(r.json.message || "Tugun topilmadi");
    } else {
      alert("Xatolik:\n" + `Status: ${r.status}\n` + (r.text||"").slice(0,300));
    }
    closeModalFn();
  });

  window.addEventListener("resize", ()=>{ if(modalBack.style.display === "flex") drawCanvas(); });
</script>
</body>
</html>
