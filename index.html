<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Qalqonsimon AI — UTT demo</title>

  <style>
    :root{
      --bg:#eef3fb;
      --panel:#ffffff;
      --blue:#0b61b3;
      --blue2:#0a4f95;
      --green:#189a4a;
      --text:#0b1320;
      --muted:#5b6b7f;
      --border:#d9e2ec;
      --shadow:0 10px 30px rgba(0,0,0,.08);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    /* ====== LAYOUT: WIDER ====== */
    .wrap{
      max-width:1440px; /* kengaytirildi */
      margin:18px auto 28px;
      padding:0 16px;
    }

    /* ====== HEADER ====== */
    .header{
      background:var(--panel);
      border-radius:26px;
      box-shadow:var(--shadow);
      padding:16px 22px 12px;
      border:1px solid var(--border);
    }

    /* 3-column header: left brand / center title / right brand */
    .hdr-top{
      display:grid;
      grid-template-columns: 330px 1fr 330px;
      align-items:center;
      gap:12px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:14px;
      min-width:0;
    }
    .brand.right{
      justify-content:flex-end;
      text-align:right;
    }

    /* bigger logos */
    .logo{
      width:74px;
      height:74px;
      border-radius:18px;
      border:1px solid #dbe6f3;
      background:#fff;
      object-fit:contain;
      padding:6px;
      box-shadow:0 8px 18px rgba(11,97,179,.10);
    }

    /* one-line text, bigger, centered-ish */
    .brandText{
      font-size:16px;
      font-weight:800;
      color:#0f2540;
      white-space:nowrap;     /* 1 qatorda */
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .centerTitle{
      text-align:center;
      padding:0 10px;
    }
    .title{
      margin:0;
      font-weight:1000;
      letter-spacing:7px;
      font-size:46px;
      line-height:1.05;
    }
    .subtitle{
      margin:6px 0 0;
      font-size:16px;
      font-weight:800;
      color:#12355a;
    }
    .desc{
      margin:10px auto 0;
      max-width:760px;
      color:var(--muted);
      font-size:14px;
      line-height:1.35;
    }

    /* ====== CONTROLS ====== */
    .controls{
      display:grid;
      grid-template-columns: 280px 1fr 1fr 150px 140px;
      gap:10px;
      align-items:center;
      padding:14px 0 0;
    }
    .fileRow{
      display:flex;
      gap:10px;
      align-items:center;
      min-width:0;
    }
    input[type="file"]{ display:none; }

    .btn{
      border:0;
      padding:11px 16px;
      border-radius:12px;
      font-weight:900;
      cursor:pointer;
      transition:.15s transform ease, .15s filter ease;
      box-shadow:0 10px 18px rgba(0,0,0,.08);
    }
    .btn:active{ transform: scale(.98); }
    .btn:hover{ filter:brightness(1.03); }
    .btn.blue{ background:var(--blue); color:#fff; }
    .btn.green{ background:linear-gradient(180deg,#1db457,#148a40); color:#fff; }
    .btn.gray{ background:#2f3b4b; color:#fff; }

    .fileName{
      flex:1;
      font-size:13px;
      color:#2a3a50;
      border:1px solid var(--border);
      border-radius:12px;
      padding:11px 12px;
      background:#f7fbff;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      min-width:0;
    }

    .inp{
      width:100%;
      border:1px solid var(--border);
      border-radius:12px;
      padding:11px 12px;
      background:#fff;
      outline:none;
      font-size:14px;
    }
    .inp:focus{
      border-color:#9cc1ea;
      box-shadow:0 0 0 3px rgba(11,97,179,.12);
    }

    /* ====== MAIN ====== */
    .grid{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap:14px;
      margin-top:14px;
    }
    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      background:linear-gradient(90deg,#0b61b3,#0a4f95);
      color:#fff;
      padding:12px 14px;
      font-weight:1000;
      font-size:18px;
    }
    .cardBody{ padding:14px; }

    .imgFrame{
      background:#f2f6fb;
      border:1px solid #dfe7f0;
      border-radius:16px;
      min-height:520px;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      overflow:hidden;
    }
    .imgFrame img{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
    }
    .placeholder{
      color:#6a7a8f;
      text-align:center;
      font-weight:800;
    }

    .note{
      margin-top:10px;
      color:#415166;
      font-size:13px;
      line-height:1.35;
    }

    /* ====== RESULT ====== */
    .centered{
      text-align:center;
    }

    .pillBig{
      display:inline-block;
      padding:10px 18px;
      border-radius:999px;
      background:linear-gradient(90deg,#0a4f95,#0b61b3);
      color:#fff;
      font-weight:1000;
      font-size:15px; /* kattaroq */
      margin:10px 0 10px;
      box-shadow:0 10px 18px rgba(11,97,179,.15);
      letter-spacing:.5px;
    }

    .midPillBig{
      display:inline-block;
      padding:10px 18px;
      border-radius:999px;
      background:linear-gradient(90deg,#0d7f63,#0fb088);
      color:#fff;
      font-weight:1000;
      font-size:15px; /* kattaroq */
      margin:14px 0 10px;
      box-shadow:0 10px 18px rgba(13,127,99,.15);
      letter-spacing:.5px;
    }

    .bigBox{
      border:1px solid #dbe7f5;
      background:#f7fbff;
      border-radius:14px;
      padding:18px;
      min-height:92px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:26px;
      font-weight:1000;
      text-align:center;
    }

    .summaryBox{
      font-size:20px;
      font-weight:900;
    }

    /* ====== FOOTER ====== */
    .footer{
      text-align:center;
      color:#6b7785;
      font-size:12px;
      margin-top:10px;
    }

    /* ====== MODAL ====== */
    .modalBack{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:50;
    }
    .modal{
      width:min(980px, 100%);
      background:#fff;
      border-radius:18px;
      box-shadow:0 20px 60px rgba(0,0,0,.25);
      overflow:hidden;
      border:1px solid rgba(0,0,0,.08);
    }
    .modalHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px 14px;
      background:#0f2741;
      color:#fff;
      font-weight:1000;
      font-size:16px;
    }
    .closeX{
      cursor:pointer;
      font-size:18px;
      padding:4px 10px;
      border-radius:10px;
      background:rgba(255,255,255,.12);
    }
    .modalBody{
      padding:12px;
      background:#0f2741;
    }
    .cropWrap{
      background:#0b1320;
      border-radius:14px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
      position:relative;
    }
    canvas{
      width:100%;
      height:auto;
      display:block;
      background:#000;
    }
    .modalBtns{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      padding:12px;
      background:#0f2741;
      flex-wrap:wrap;
    }
    .btn.orange{ background:#f0a81a; color:#1b1200; }
    .btn.white{ background:#eef3f8; color:#142033; box-shadow:none; }

    @media (max-width: 1100px){
      .hdr-top{ grid-template-columns: 1fr; }
      .brand, .brand.right{ justify-content:center; text-align:center; }
      .brandText{ justify-self:center; }
      .controls{ grid-template-columns: 1fr; }
      .grid{ grid-template-columns: 1fr; }
      .imgFrame{ min-height:360px; }
      .title{ font-size:40px; letter-spacing:5px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">

      <div class="hdr-top">
        <div class="brand">
          <img class="logo" id="logoLeft" src="logo_left.png" alt="Logo left" />
          <div class="brandText">Tibbiy radiologiya kafedrasi №2</div>
        </div>

        <div class="centerTitle">
          <h1 class="title">QALQONSIMON AI</h1>
          <div class="subtitle">UTT tasvirida tugunlarni baholash yordamchisi</div>
          <div class="desc">
            Qalqonsimon bez UTT tasvirini yuklang va <b>“Tahlil qilish”</b> tugmasini bosing.
          </div>
        </div>

        <div class="brand right">
          <div class="brandText">Toshkent Davlat Tibbiyot Universiteti</div>
          <img class="logo" id="logoRight" src="logo_right.png" alt="Logo right" />
        </div>
      </div>

      <div class="controls">
        <div class="fileRow">
          <label class="btn blue" for="file">Faylni tanlash</label>
          <input id="file" type="file" accept="image/*" />
          <div class="fileName" id="fileName">Fayl tanlanmadi</div>
        </div>

        <input class="inp" id="deviceName" placeholder="Apparat nomi (ixtiyoriy)" />
        <input class="inp" id="noduleSize" placeholder="Tugun o‘lchami (mm)" />

        <button class="btn green" id="analyzeBtn">Tahlil qilish</button>
        <button class="btn gray" id="resetBtn">Qayta tiklash</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="cardHead">Rasm</div>
        <div class="cardBody">
          <div class="imgFrame" id="mainFrame">
            <div class="placeholder" id="mainPlaceholder">Rasm yuklanmagan</div>
            <img id="mainImg" style="display:none;" alt="UTT rasm" />
          </div>
          <div class="note">
            “Tahlil qilish” → ROI tanlanadi (AI bilan belgilash / qo‘lda belgilash / belgilanmasin). Tanlangandan keyin asosiy rasm ROI (crop) bilan almashadi.
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="cardHead">Natija</div>
        <div class="cardBody">

          <div class="centered">
            <div class="pillBig">TUGUN MALIGNLIK EHTIMOLI</div>
          </div>

          <div class="bigBox" id="riskBox">Baholash keyin qo‘shiladi</div>

          <div class="centered">
            <div class="midPillBig">MODEL XULOSASI</div>
          </div>

          <div class="bigBox summaryBox" id="summaryBox">Rasm yuklang va tahlil qiling</div>

          <div class="note" style="margin-top:12px;">
            <b>Eslatma:</b> Bu AI modeli klinik qarorni belgilamaydi. Yakuniy xulosa shifokor tomonidan klinik holat va qo‘shimcha tekshiruvlar asosida beriladi.
          </div>

        </div>
      </div>
    </div>

    <div class="footer">© Qalqonsimon AI — tadqiqot uchun demo modeli</div>
  </div>

  <!-- MODAL -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="modalHead">
        <div>ROI belgilash</div>
        <div class="closeX" id="closeModal">✕</div>
      </div>

      <div class="modalBody">
        <div class="cropWrap">
          <canvas id="canvas"></canvas>
        </div>
      </div>

      <div class="modalBtns">
        <button class="btn orange" id="aiBtn">AI bilan belgilash</button>
        <button class="btn white" id="noCropBtn">Belgilanmasin</button>
        <button class="btn green" id="manualCropBtn">Qo‘lda belgilash</button>
      </div>
    </div>
  </div>

<script>
  // =========================
  // API BASE (sizning HF Space)
  // =========================
  const API_BASE = "https://bekjonsattorov256-qalqonsimon-api.hf.space";

  // Elements
  const fileEl = document.getElementById("file");
  const fileNameEl = document.getElementById("fileName");
  const mainImg = document.getElementById("mainImg");
  const mainPlaceholder = document.getElementById("mainPlaceholder");

  const analyzeBtn = document.getElementById("analyzeBtn");
  const resetBtn = document.getElementById("resetBtn");

  const modalBack = document.getElementById("modalBack");
  const closeModal = document.getElementById("closeModal");

  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");

  const aiBtn = document.getElementById("aiBtn");
  const noCropBtn = document.getElementById("noCropBtn");
  const manualCropBtn = document.getElementById("manualCropBtn");

  const riskBox = document.getElementById("riskBox");
  const summaryBox = document.getElementById("summaryBox");

  // State
  let originalFile = null;
  let originalImage = new Image();
  let imgLoaded = false;

  // manual selection
  let selecting = false;
  let rect = null; // {x,y,w,h}
  let start = null;

  function openModal(){ modalBack.style.display = "flex"; }
  function hideModal(){
    modalBack.style.display = "none";
    selecting = false; start = null; rect = null;
    drawCanvas();
  }

  function fileToImage(file){
    return new Promise((resolve,reject)=>{
      const reader = new FileReader();
      reader.onload = () => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = reader.result;
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  function drawCanvas(){
    if(!imgLoaded) return;
    const maxW = canvas.parentElement.clientWidth;
    const scale = maxW / originalImage.width;
    canvas.width = Math.floor(originalImage.width * scale);
    canvas.height = Math.floor(originalImage.height * scale);

    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(originalImage, 0,0, canvas.width, canvas.height);

    if(rect){
      ctx.save();
      ctx.strokeStyle = "#1da1ff";
      ctx.lineWidth = 3;
      ctx.strokeRect(rect.x, rect.y, rect.w, rect.h);
      ctx.restore();
    }
  }

  async function callAnalyze(file){
    const fd = new FormData();
    fd.append("image", file);
    const r = await fetch(`${API_BASE}/analyze`, { method:"POST", body:fd });
    return await r.json();
  }

  function setMainImageFromBlob(blob){
    const url = URL.createObjectURL(blob);
    mainImg.onload = () => {
      mainImg.style.display = "block";
      mainPlaceholder.style.display = "none";
    };
    mainImg.src = url;
  }

  function cropFromRectScaledToOriginal(){
    const scale = originalImage.width / canvas.width;
    const x = Math.round(rect.x * scale);
    const y = Math.round(rect.y * scale);
    const w = Math.round(rect.w * scale);
    const h = Math.round(rect.h * scale);

    const tmp = document.createElement("canvas");
    tmp.width = Math.max(1,w);
    tmp.height = Math.max(1,h);
    const tctx = tmp.getContext("2d");
    tctx.drawImage(originalImage, x, y, w, h, 0, 0, w, h);

    return new Promise(resolve => tmp.toBlob(resolve, "image/jpeg", 0.95));
  }

  function toPct(p){
    const pct = Math.round(p * 100);
    return `${pct}%`;
  }

  function triageUz(triage, p){
    // triage kelishi: "benign" / "malignant" / "suspicious" bo'lishi mumkin
    // agar backend faqat benign/malignant bersa ham ishlaydi
    const pp = p ?? null;
    if(triage === "malignant") return "Yomon xulqli (malignant)";
    if(triage === "benign") return "Yaxshi xulqli (benign)";
    if(triage === "suspicious") return "Shubhali (FNA/TAB)";
    // fallback:
    if(pp !== null){
      if(pp < 0.40) return "Yaxshi xulqli (benign)";
      if(pp > 0.75) return "Yomon xulqli (malignant)";
      return "Shubhali (FNA/TAB)";
    }
    return "Natija tayyor emas";
  }

  // EVENTS
  fileEl.addEventListener("change", async (e)=>{
    const f = e.target.files?.[0];
    if(!f) return;
    originalFile = f;
    fileNameEl.textContent = f.name;

    originalImage = await fileToImage(f);
    imgLoaded = true;

    mainImg.src = originalImage.src;
    mainImg.style.display = "block";
    mainPlaceholder.style.display = "none";

    riskBox.textContent = "Baholash keyin qo‘shiladi";
    summaryBox.textContent = "Rasm yuklang va tahlil qiling";
  });

  analyzeBtn.addEventListener("click", ()=>{
    if(!originalFile){
      alert("Avval rasm yuklang.");
      return;
    }
    openModal();
    setTimeout(drawCanvas, 60);
  });

  resetBtn.addEventListener("click", ()=>{
    originalFile = null;
    fileEl.value = "";
    fileNameEl.textContent = "Fayl tanlanmadi";

    mainImg.style.display="none";
    mainPlaceholder.style.display="block";
    mainImg.src = "";

    riskBox.textContent = "Baholash keyin qo‘shiladi";
    summaryBox.textContent = "Rasm yuklang va tahlil qiling";

    hideModal();
  });

  closeModal.addEventListener("click", hideModal);
  modalBack.addEventListener("click", (e)=>{
    if(e.target === modalBack) hideModal();
  });

  // Manual selection on canvas
  canvas.addEventListener("mousedown", (e)=>{
    if(!selecting) return;
    const r = canvas.getBoundingClientRect();
    start = { x: e.clientX - r.left, y: e.clientY - r.top };
    rect = { x:start.x, y:start.y, w:1, h:1 };
    drawCanvas();
  });
  canvas.addEventListener("mousemove", (e)=>{
    if(!selecting || !start) return;
    const r = canvas.getBoundingClientRect();
    const x = e.clientX - r.left;
    const y = e.clientY - r.top;
    rect.w = x - start.x;
    rect.h = y - start.y;
    if(rect.w < 0){ rect.x = x; rect.w = Math.abs(rect.w); } else rect.x = start.x;
    if(rect.h < 0){ rect.y = y; rect.h = Math.abs(rect.h); } else rect.y = start.y;
    drawCanvas();
  });
  canvas.addEventListener("mouseup", async ()=>{
    if(!selecting || !rect) return;
    selecting = false;
    start = null;
    drawCanvas();

    const roiBlob = await cropFromRectScaledToOriginal();
    hideModal();

    // analyze on ROI blob by sending to /classify (faster) OR just local -> but we use /classify
    // We'll call /classify endpoint:
    const fd = new FormData();
    fd.append("image", roiBlob, "roi.jpg");
    const r = await fetch(`${API_BASE}/classify`, { method:"POST", body:fd });
    const js = await r.json();
    if(!js.ok){
      alert("Xatolik: backend javobi noto‘g‘ri.");
      return;
    }
    const p = js.p_malignant;
    riskBox.textContent = toPct(p);
    summaryBox.textContent = triageUz(js.triage, p);

    // replace main image with ROI
    setMainImageFromBlob(roiBlob);
  });

  // Modal buttons
  aiBtn.addEventListener("click", async ()=>{
    if(!originalFile) return;

    aiBtn.disabled = true;
    const old = aiBtn.textContent;
    aiBtn.textContent = "Kutib turing...";
    try{
      const js = await callAnalyze(originalFile);
      if(!js.ok){
        alert("Xatolik: backend javobi noto‘g‘ri.");
        return;
      }
      if(!js.found){
        alert("AI tugun topolmadi. Qo‘lda belgilashni tanlang.");
        return;
      }

      const p = js.p_malignant;
      riskBox.textContent = toPct(p);
      summaryBox.textContent = triageUz(js.triage, p);

      // crop on client using bbox
      const [x1,y1,x2,y2] = js.bbox;
      const w = Math.max(1, x2 - x1);
      const h = Math.max(1, y2 - y1);

      const tmp = document.createElement("canvas");
      tmp.width = w; tmp.height = h;
      const tctx = tmp.getContext("2d");
      tctx.drawImage(originalImage, x1, y1, w, h, 0, 0, w, h);

      const roiBlob = await new Promise(res => tmp.toBlob(res, "image/jpeg", 0.95));
      setMainImageFromBlob(roiBlob); // asosiy frame ROI bilan almashadi
      hideModal();

    } finally {
      aiBtn.disabled = false;
      aiBtn.textContent = old;
    }
  });

  noCropBtn.addEventListener("click", async ()=>{
    hideModal();
    // full image classify (optional)
    const fd = new FormData();
    fd.append("image", originalFile, originalFile.name);
    const r = await fetch(`${API_BASE}/classify`, { method:"POST", body:fd });
    const js = await r.json();
    if(js.ok){
      const p = js.p_malignant;
      riskBox.textContent = toPct(p);
      summaryBox.textContent = triageUz(js.triage, p);
    } else {
      summaryBox.textContent = "ROI tanlanmadi";
    }
  });

  manualCropBtn.addEventListener("click", ()=>{
    selecting = true;
    rect = null;
    start = null;
    drawCanvas();
    alert("ROI ni sichqoncha bilan tortib belgilang (drag).");
  });

  window.addEventListener("resize", ()=>{
    if(modalBack.style.display === "flex") drawCanvas();
  });
</script>
</body>
</html>
