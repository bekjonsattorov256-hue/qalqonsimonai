<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Qalqonsimon AI — UTT demo</title>

  <style>
    :root{
      --bg:#eef4fb;
      --panel:#ffffff;
      --blue:#0b61b3;
      --blue2:#094a8d;
      --green:#169a4a;
      --gray:#2f3a49;
      --border:#d6e2f2;
      --shadow:0 14px 40px rgba(10,30,60,.12);
      --radius:20px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 700px at 30% 0%, #f7fbff 0%, var(--bg) 55%, #eaf2ff 100%);
      color:#0b1320;
    }

    .wrap{
      max-width: 1680px;
      margin: 18px auto 26px;
      padding: 0 16px;
    }

    .header{
      background:var(--panel);
      border-radius:26px;
      box-shadow:var(--shadow);
      border:1px solid var(--border);
      padding:18px 22px 12px;
      position:relative;
      overflow:hidden;
    }
    .header:before{
      content:"";
      position:absolute; inset:-120px -160px auto auto;
      width:420px; height:420px;
      background: radial-gradient(circle at 30% 30%, rgba(11,97,179,.18), rgba(11,97,179,0) 60%);
      transform: rotate(12deg);
      pointer-events:none;
    }

    .hdr-top{
      display:grid;
      grid-template-columns: 320px 1fr 320px;
      align-items:center;
      gap:14px;
    }

    .logoBox{
      display:flex;
      align-items:center;
      gap:14px;
      min-width:0;
    }
    .logoBox.right{ justify-content:flex-end; }
    .logo{
      width:68px; height:68px;
      border-radius:16px;
      border:2px solid #e5eefb;
      object-fit:contain;
      background:#fff;
      padding:6px;
      box-shadow: 0 8px 20px rgba(10,30,60,.08);
    }
    .logoText{
      font-size:18px;
      font-weight:900;
      color:#13233b;
      line-height:1.15;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .titleBlock{ text-align:center; }
    .title{
      margin:0;
      font-size:46px;
      letter-spacing:7px;
      font-weight:1000;
    }
    .subtitle{
      margin:4px 0 0;
      font-size:18px;
      font-weight:800;
      color:#17355a;
    }
    .desc{
      margin:10px 0 0;
      font-size:14px;
      color:#3b4a5f;
    }

    .controls{
      margin-top:14px;
      display:grid;
      grid-template-columns: 280px 1fr 1fr 160px 150px;
      gap:10px;
      align-items:center;
    }

    .btn{
      border:0;
      padding:11px 14px;
      border-radius:12px;
      font-weight:900;
      cursor:pointer;
      transition:.15s transform ease, .15s filter ease;
      box-shadow: 0 8px 18px rgba(10,30,60,.08);
    }
    .btn:active{ transform: scale(.985); }
    .btn.blue{ background: linear-gradient(180deg, #0f6fd0, var(--blue)); color:#fff; }
    .btn.green{ background: linear-gradient(180deg, #19b35a, var(--green)); color:#fff; }
    .btn.gray{ background: linear-gradient(180deg, #3a4657, var(--gray)); color:#fff; }
    .btn:disabled{ opacity:.65; cursor:not-allowed; box-shadow:none; }

    .fileRow{ display:flex; gap:10px; align-items:center; }
    input[type="file"]{ display:none; }
    .fileName{
      font-size:13px;
      color:#314056;
      border:1px solid var(--border);
      border-radius:12px;
      padding:11px 12px;
      background:#f7fbff;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      flex:1;
    }
    .inp{
      width:100%;
      border:1px solid var(--border);
      border-radius:12px;
      padding:11px 12px;
      background:#fff;
      outline:none;
      font-size:14px;
    }
    .inp:focus{ border-color:#9cc1ea; box-shadow:0 0 0 4px rgba(11,97,179,.12); }

    .grid{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap:14px;
      margin-top:12px;
    }

    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      background: linear-gradient(180deg, #0f6fd0, #0b5aa6);
      color:#fff;
      padding:11px 14px;
      font-weight:1000;
      font-size:18px;
    }
    .cardBody{ padding:14px; }

    .imgFrame{
      background:#f2f7ff;
      border:1px solid #dfe9f7;
      border-radius:18px;
      min-height: 540px;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      overflow:hidden;
    }
    .imgFrame img{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
    }
    .placeholder{
      color:#6a7a8f;
      text-align:center;
      font-weight:800;
    }

    /* ✅ bbox overlay */
    .bboxOverlay{
      position:absolute;
      inset:0;
      pointer-events:none;
      display:none;
      border-radius:18px;
    }

    .note{
      margin-top:10px;
      color:#415166;
      font-size:13px;
      line-height:1.45;
    }

    .center{ text-align:center; }

    .pill{
      display:inline-block;
      padding:10px 18px;
      border-radius:999px;
      background: linear-gradient(180deg, #0f6fd0, #0b5aa6);
      color:#fff;
      font-weight:1000;
      font-size:15px;
      margin:8px 0 12px;
      box-shadow: 0 10px 22px rgba(11,97,179,.18);
    }
    .pill.green{
      background: linear-gradient(180deg, #19b35a, #0d7f63);
      box-shadow: 0 10px 22px rgba(13,127,99,.18);
    }

    .bigBox{
      border:1px solid #dbe7f5;
      background:#f7fbff;
      border-radius:16px;
      padding:18px;
      min-height:88px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:28px;
      font-weight:1000;
      text-align:center;
    }
    .bigBox.small{
      font-size:20px;
      min-height:76px;
    }

    .disclaimerBox{
      margin-top:14px;
      border-radius:16px;
      border:1px solid #ffe2b6;
      background: linear-gradient(180deg, #fff7e9, #fff2dd);
      padding:16px 16px;
      color:#5a3a00;
      font-weight:1000;
      font-size:16px;
      line-height:1.55;
    }
    .disclaimerBox b{ color:#3a2500; }

    .footer{
      text-align:center;
      color:#6b7785;
      font-size:12px;
      margin-top:10px;
    }

    .logoutBtn{
      padding:12px 18px;
      border-radius:999px;
      border:1px solid #d6e2f2;
      background:#fff;
      color:#0b4fa2;
      font-weight:1000;
      cursor:pointer;
      box-shadow: 0 10px 22px rgba(10,30,60,.12);
      width:auto;
    }
    .logoutBtn:hover{ filter:brightness(.98); }
    .logoutBtn:active{ transform:scale(.97); }

    .floatingLogout{
      position:fixed;
      right:22px;
      bottom:22px;
      z-index:350;
      background: linear-gradient(180deg, #ffffff, #f2f6ff);
      box-shadow: 0 14px 32px rgba(10,30,60,.18);
    }

    /* ====== LOGIN SCREEN ====== */
    .gate{
      position:fixed; inset:0;
      background: radial-gradient(1100px 700px at 25% 0%, #f7fbff 0%, #eef4fb 55%, #eaf2ff 100%);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:200;
    }
    .loginShell{
      width:min(1080px, 100%);
      background:#fff;
      border:1px solid var(--border);
      border-radius:26px;
      box-shadow:var(--shadow);
      overflow:hidden;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      min-height: 520px;
    }
    .brandPane{
      padding:28px 30px;
      background: linear-gradient(135deg, #ffffff 0%, #f3f8ff 70%, #eef6ff 100%);
      position:relative;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      text-align:center;
    }
    .brandPane:after{
      content:"";
      position:absolute; inset:auto -120px -140px auto;
      width:520px; height:520px;
      background: radial-gradient(circle at 30% 30%, rgba(11,97,179,.22), rgba(11,97,179,0) 60%);
      transform: rotate(-10deg);
      pointer-events:none;
    }
    .brandRow{
      display:flex; align-items:center; gap:16px;
      justify-content:center;
      z-index:1;
    }
    .brandLogo{
      width:92px; height:92px;
      border-radius:20px;
      border:2px solid #e5eefb;
      background:#fff;
      object-fit:contain;
      padding:8px;
      box-shadow: 0 10px 22px rgba(10,30,60,.10);
    }
    .brandTitle{
      margin:0;
      font-size:40px;
      letter-spacing:6px;
      font-weight:1000;
      line-height:1.05;
    }
    .brandSub{
      margin-top:10px;
      font-size:16px;
      font-weight:800;
      color:#17355a;
      z-index:1;
    }
    .formPane{
      padding:28px 26px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:12px;
      background:#fff;
    }
    .loginTitle{
      margin:0 0 6px;
      font-size:18px;
      font-weight:1000;
      color:#13233b;
      letter-spacing:.5px;
    }
    .loginBtn{
      width:100%;
      padding:12px 14px;
      border-radius:12px;
      border:0;
      background: linear-gradient(180deg, #0f6fd0, var(--blue));
      color:#fff;
      font-weight:1000;
      cursor:pointer;
      box-shadow: 0 10px 20px rgba(11,97,179,.18);
    }
    .loginErr{
      color:#b00020;
      font-weight:800;
      font-size:13px;
      min-height: 18px;
    }

    /* ====== CONSENT MODAL ====== */
    .consentBack{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:210;
    }
    .consent{
      width:min(980px, 100%);
      background:#fff;
      border-radius:18px;
      box-shadow:0 24px 70px rgba(0,0,0,.28);
      border:1px solid rgba(0,0,0,.08);
      overflow:hidden;
    }
    .consentHead{
      padding:14px 16px;
      background:#0f2741;
      color:#fff;
      font-weight:1000;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .consentBody{
      padding:18px 16px;
      color:#13233b;
      line-height:1.7;
      font-size:15px;
    }
    .consentFooter{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:14px 16px;
      border-top:1px solid #e8eef7;
      background:#fbfdff;
      flex-wrap:wrap;
    }
    .checkRow{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:900;
      color:#17355a;
    }

    @media (max-width: 1050px){
      .hdr-top{ grid-template-columns: 1fr; text-align:center; }
      .logoBox, .logoBox.right{ justify-content:center; }
      .controls{ grid-template-columns: 1fr; }
      .grid{ grid-template-columns: 1fr; }
      .imgFrame{ min-height:360px; }
      .loginShell{ grid-template-columns: 1fr; }
      .brandRow{ flex-direction:column; }
      .brandTitle{ letter-spacing:4px; }
    }
  </style>
</head>

<body>

  <!-- ===== LOGIN GATE ===== -->
  <div class="gate" id="gate">
    <div class="loginShell">
      <div class="brandPane">
        <div class="brandRow">
          <img class="brandLogo" src="logo_left.png" alt="Logo">
          <div>
            <h1 class="brandTitle">QALQONSIMON AI</h1>
          </div>
        </div>
        <div class="brandSub">UTT tasvirida tugunlarni baholash yordamchisi</div>
      </div>

      <div class="formPane">
        <div class="loginTitle">Kirish</div>
        <input class="inp" id="loginUser" placeholder="Login" autocomplete="username">
        <input class="inp" id="loginPass" placeholder="Parol" type="password" autocomplete="current-password">
        <div class="loginErr" id="loginErr"></div>
        <button class="loginBtn" id="loginBtn">Kirish</button>
        <div style="font-size:12px;color:#5a6b82;line-height:1.5;">
          * Bu demo verison uchun.
        </div>
      </div>
    </div>
  </div>

  <!-- ===== CONSENT MODAL ===== -->
  <div class="consentBack" id="consentBack">
    <div class="consent">
      <div class="consentHead">
        <div>Ogohlantirish va rozilik</div>
        <div class="closeX" id="closeConsent">✕</div>
      </div>

      <div class="consentBody">
        Men “Qalqonsimon AI” dasturi tijorat (klinika) foydalanish uchun mo‘ljallanmagan,
        faqat ilmiy-tadqiqot (research) maqsadidagi demo ekanligini to‘liq tushunaman.
        <br><br>
        Ushbu dastur klinik qarorni belgilamaydi.
        Yakuniy xulosa shifokor tomonidan klinik holat va qo‘shimcha tekshiruvlar asosida beriladi.
        <br><br>
        Agar dasturdan tadqiqotdan tashqari maqsadlarda foydalanish oqibatida huquqiy yoki boshqa
        muammolar yuzaga kelsa, barcha javobgarlik (shu jumladan huquqiy javobgarlik)
        to‘liq foydalanuvchi zimmasida ekanligini tasdiqlayman.
      </div>

      <div class="consentFooter">
        <label class="checkRow">
          <input type="checkbox" id="agreeCheck">
          Yuqoridagilarni o‘qib chiqdim va roziman.
        </label>
        <button class="btn blue" id="agreeBtn" disabled>Davom etish</button>
      </div>
    </div>
  </div>

  <!-- ===== MAIN APP ===== -->
  <div class="wrap" id="app" style="display:none;">
    <div class="header">
      <div class="hdr-top">
        <div class="logoBox">
          <img class="logo" id="logoLeft" src="logo_left.png" alt="Logo left" />
          <div>
            <div class="logoText">Tibbiy radiologiya kafedrasi №2</div>
          </div>
        </div>

        <div class="titleBlock">
          <h1 class="title">QALQONSIMON AI</h1>
          <div class="subtitle">UTT tasvirida tugunlarni baholash yordamchisi</div>
          <div class="desc">
            Qalqonsimon bez UTT tasvirini yuklang va <b>“Tahlil qilish”</b> tugmasini bosing.
          </div>
        </div>

        <div class="logoBox right">
          <div style="text-align:right;">
            <div class="logoText">Toshkent Davlat Tibbiyot Universiteti</div>
          </div>
          <img class="logo" id="logoRight" src="logo_right.png" alt="Logo right" />
        </div>
      </div>

      <div class="controls">
        <div class="fileRow">
          <label class="btn blue" for="file">Faylni tanlash</label>
          <input id="file" type="file" accept="image/*" />
          <div class="fileName" id="fileName">Fayl tanlanmadi</div>
        </div>
        <input class="inp" id="deviceName" placeholder="Apparat nomi (ixtiyoriy)" />
        <input class="inp" id="noduleSize" placeholder="Tugun o‘lchami (mm)" />
        <button class="btn green" id="analyzeBtn">Tahlil qilish</button>
        <button class="btn gray" id="resetBtn">Qayta tiklash</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="cardHead">Rasm</div>
        <div class="cardBody">
          <div class="imgFrame" id="mainFrame">
            <div class="placeholder" id="mainPlaceholder">Rasm yuklanmagan</div>
            <img id="mainImg" style="display:none;" alt="UTT rasm" />
            <!-- ✅ bbox overlay canvas -->
            <canvas id="bboxCanvas" class="bboxOverlay"></canvas>
          </div>
          <div class="note">
            Endi tizim bitta so‘rov bilan ishlaydi: <b>/analyze</b> (YOLO + crop + multi-crop).
            Frontend crop qilmaydi — natija barqaror bo‘ladi.
          </div>
        </div>
      </div>

      <div class="card">
        <div class="cardHead">Natija</div>
        <div class="cardBody">

          <div class="center">
            <div class="pill">TUGUN YOMON SIFATLILIK EHTIMOLI</div>
          </div>
          <div class="bigBox" id="riskBox">—</div>

          <div class="center" style="margin-top:14px;">
            <div class="pill green">MODEL XULOSASI</div>
          </div>
          <div class="bigBox small" id="summaryBox">Rasm yuklang va tahlil qiling</div>

          <div class="disclaimerBox">
            <b>Eslatma:</b> Bu AI modeli klinik qarorni belgilamaydi.
            Yakuniy xulosa shifokor tomonidan klinik holat va qo‘shimcha tekshiruvlar asosida beriladi.
          </div>

        </div>
      </div>
    </div>

    <div class="footer">© Qalqonsimon AI — tadqiqot uchun demo modeli</div>
  </div>

  <button class="logoutBtn floatingLogout" id="logoutBtn" type="button" style="display:none;">
    Chiqish
  </button>

<script>
  // =========================
  // ✅ API BASE (o'zgarmadi)
  // =========================
  const API_BASE = "https://bekjonsattorov256-qalqonsimon-api.hf.space";

  // DEMO LOGIN
  const DEMO_USER = "doctor";
  const DEMO_PASS = "12345";

  // Elements: Gate + Consent
  const gate = document.getElementById("gate");
  const app = document.getElementById("app");
  const loginUser = document.getElementById("loginUser");
  const loginPass = document.getElementById("loginPass");
  const loginBtn  = document.getElementById("loginBtn");
  const loginErr  = document.getElementById("loginErr");

  const consentBack = document.getElementById("consentBack");
  const agreeCheck  = document.getElementById("agreeCheck");
  const agreeBtn    = document.getElementById("agreeBtn");
  const closeConsent = document.getElementById("closeConsent");

  // floating logout
  const logoutBtn = document.getElementById("logoutBtn");

  function showConsent(){
    consentBack.style.display = "flex";
    agreeCheck.checked = false;
    agreeBtn.disabled = true;
    if(logoutBtn) logoutBtn.style.display = "none";
  }
  function hideConsent(){
    consentBack.style.display = "none";
  }

  function enterApp(){
    gate.style.display = "none";
    app.style.display = "block";
    if(logoutBtn) logoutBtn.style.display = "block";
  }

  const LS_LOGIN = "qalqonsimon_logged_in";
  const LS_AGREE = "qalqonsimon_agreed";

  function doLogout(){
    localStorage.removeItem(LS_LOGIN);
    localStorage.removeItem(LS_AGREE);

    hideConsent();
    gate.style.display = "flex";
    app.style.display = "none";

    if(logoutBtn) logoutBtn.style.display = "none";

    if(loginUser) loginUser.value = "";
    if(loginPass) loginPass.value = "";
    if(loginErr) loginErr.textContent = "";
  }

  function boot(){
    const logged = localStorage.getItem(LS_LOGIN) === "1";
    const agreed = localStorage.getItem(LS_AGREE) === "1";

    if(!logged){
      gate.style.display = "flex";
      app.style.display = "none";
      if(logoutBtn) logoutBtn.style.display = "none";
      return;
    }
    if(!agreed){
      gate.style.display = "none";
      app.style.display = "none";
      if(logoutBtn) logoutBtn.style.display = "none";
      showConsent();
      return;
    }
    hideConsent();
    enterApp();
    resetIdleTimer();
  }

  loginBtn.addEventListener("click", ()=>{
    const u = (loginUser.value || "").trim();
    const p = (loginPass.value || "").trim();

    if(u === DEMO_USER && p === DEMO_PASS){
      localStorage.setItem(LS_LOGIN, "1");
      loginErr.textContent = "";
      gate.style.display = "none";
      app.style.display = "none";
      if(logoutBtn) logoutBtn.style.display = "none";
      showConsent();
    } else {
      loginErr.textContent = "Login yoki parol noto‘g‘ri.";
    }
  });

  loginPass.addEventListener("keydown", (e)=>{
    if(e.key === "Enter") loginBtn.click();
  });

  agreeCheck.addEventListener("change", ()=>{
    agreeBtn.disabled = !agreeCheck.checked;
  });

  agreeBtn.addEventListener("click", ()=>{
    localStorage.setItem(LS_AGREE, "1");
    hideConsent();
    enterApp();
    resetIdleTimer();
  });

  closeConsent.addEventListener("click", ()=>{
    doLogout();
  });

  if(logoutBtn){
    logoutBtn.addEventListener("click", ()=>{
      doLogout();
    });
  }

  // =========================
  // AUTO LOGOUT: 5 daqiqa inactivity
  // =========================
  const AUTO_LOGOUT_MS = 5 * 60 * 1000;
  let idleTimer = null;

  function resetIdleTimer(){
    if(idleTimer) clearTimeout(idleTimer);

    const logged = localStorage.getItem(LS_LOGIN) === "1";
    const agreed = localStorage.getItem(LS_AGREE) === "1";
    if(!(logged && agreed)) return;

    idleTimer = setTimeout(()=>{
      alert("5 daqiqa faoliyat bo‘lmadi. Xavfsizlik uchun tizimdan chiqildi.");
      doLogout();
    }, AUTO_LOGOUT_MS);
  }

  ["mousemove","mousedown","keydown","scroll","touchstart","click"].forEach(evt=>{
    window.addEventListener(evt, resetIdleTimer, { passive:true });
  });

  // =========================
  // MAIN UI
  // =========================
  const fileEl = document.getElementById("file");
  const fileNameEl = document.getElementById("fileName");
  const mainImg = document.getElementById("mainImg");
  const mainPlaceholder = document.getElementById("mainPlaceholder");
  const analyzeBtn = document.getElementById("analyzeBtn");
  const resetBtn = document.getElementById("resetBtn");

  const riskBox = document.getElementById("riskBox");
  const summaryBox = document.getElementById("summaryBox");

  // ✅ bbox overlay canvas
  const bboxCanvas = document.getElementById("bboxCanvas");
  const bboxCtx = bboxCanvas.getContext("2d");

  let originalFile = null;
  let originalImage = new Image();
  let imgLoaded = false;

  function fileToImage(file){
    return new Promise((resolve,reject)=>{
      const reader = new FileReader();
      reader.onload = () => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = reader.result;
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  function clearBBox(){
    bboxCanvas.style.display = "none";
    bboxCtx.clearRect(0,0,bboxCanvas.width,bboxCanvas.height);
  }

  function drawBBoxOnMainImage(bbox){
    if(!imgLoaded || !bbox) return;

    // canvas same size as frame
    const frame = document.getElementById("mainFrame");
    const rect = frame.getBoundingClientRect();
    bboxCanvas.width = Math.floor(rect.width);
    bboxCanvas.height = Math.floor(rect.height);

    bboxCtx.clearRect(0,0,bboxCanvas.width,bboxCanvas.height);

    // mainImg object-fit: contain => hisoblash
    const cw = bboxCanvas.width;
    const ch = bboxCanvas.height;
    const iw = originalImage.width;
    const ih = originalImage.height;

    const scale = Math.min(cw / iw, ch / ih);
    const drawW = iw * scale;
    const drawH = ih * scale;
    const offX = (cw - drawW) / 2;
    const offY = (ch - drawH) / 2;

    // bbox original image koordinatada
    const [x1,y1,x2,y2] = bbox;
    const bx = offX + x1 * scale;
    const by = offY + y1 * scale;
    const bw = (x2 - x1) * scale;
    const bh = (y2 - y1) * scale;

    bboxCtx.save();
    bboxCtx.strokeStyle = "#00d4ff";
    bboxCtx.lineWidth = 3;
    bboxCtx.strokeRect(bx, by, bw, bh);
    bboxCtx.restore();

    bboxCanvas.style.display = "block";
  }

  // ✅ YANGI FUNKSIYA: faqat /analyze ishlaydi
  async function callAnalyzeFullImage(file){
    const fd = new FormData();
    fd.append("image", file);

    const r = await fetch(`${API_BASE}/analyze`, {
      method: "POST",
      body: fd
    });
    return await r.json();
  }

  async function applyAnalyzeResult(file){
    try{
      // UI: rasmni ko'rsatamiz (original rasm)
      const img = await fileToImage(file);
      originalImage = img;
      imgLoaded = true;

      mainImg.src = originalImage.src;
      mainImg.style.display = "block";
      mainPlaceholder.style.display = "none";

      clearBBox();
      riskBox.textContent = "—";
      summaryBox.textContent = "Tahlil qilinmoqda...";

      const res = await callAnalyzeFullImage(file);
      console.log("ANALYZE JSON:", res); // ✅ siz tekshirish uchun

      if(!res || res.ok === false){
        riskBox.textContent = "—";
        summaryBox.textContent = "Xatolik: natija olinmadi";
        return;
      }
      if(!res.found){
        riskBox.textContent = "—";
        summaryBox.textContent = "AI tugun topolmadi";
        return;
      }

      const p = Math.max(0, Math.min(1, Number(res.p_malignant ?? 0)));
      const pct = Math.round(p * 100);

      riskBox.textContent = `${pct}%`;

      // triage matnini chiroyli ko'rsatamiz
      const t = (res.triage || "").toLowerCase();
      if(t === "benign") summaryBox.textContent = "YAXSHI SIFATLI";
      else if(t === "suspicious") summaryBox.textContent = "SHUBHALI";
      else if(t === "malignant") summaryBox.textContent = "YOMON SIFATLI";
      else summaryBox.textContent = res.triage || "Natija tayyor";

      // bbox chizamiz
      if(res.bbox) drawBBoxOnMainImage(res.bbox);

    } catch(e){
      riskBox.textContent = "—";
      summaryBox.textContent = "Xatolik: backend ulanmagan";
      console.error(e);
    }
  }

  fileEl.addEventListener("change", async (e)=>{
    const f = e.target.files?.[0];
    if(!f) return;

    originalFile = f;
    fileNameEl.textContent = f.name;

    // ko'rsatamiz
    originalImage = await fileToImage(f);
    imgLoaded = true;

    mainImg.src = originalImage.src;
    mainImg.style.display = "block";
    mainPlaceholder.style.display = "none";

    clearBBox();
    riskBox.textContent = "—";
    summaryBox.textContent = "Rasm yuklang va tahlil qiling";

    resetIdleTimer();
  });

  analyzeBtn.addEventListener("click", async ()=>{
    if(!originalFile){
      alert("Avval rasm yuklang.");
      return;
    }
    resetIdleTimer();
    await applyAnalyzeResult(originalFile);
  });

  resetBtn.addEventListener("click", ()=>{
    originalFile = null;
    fileEl.value = "";
    fileNameEl.textContent = "Fayl tanlanmadi";

    mainImg.style.display="none";
    mainPlaceholder.style.display="block";
    mainImg.src = "";

    clearBBox();

    riskBox.textContent = "—";
    summaryBox.textContent = "Rasm yuklang va tahlil qiling";

    resetIdleTimer();
  });

  window.addEventListener("resize", ()=>{
    // resize bo'lsa bbox qayta chizish uchun, lekin faqat oldingi bbox saqlanmagan.
    // oddiy: clear qilamiz
    clearBBox();
  });

  boot();
</script>
</body>
</html>
